<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<title>Cardwolla</title>

	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
	<script type="text/javascript" src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
	
	<script type="text/javascript"  src="//cdnjs.cloudflare.com/ajax/libs/jquery.payment/1.0.1/jquery.payment.js"></script>
	
	<!-- Custom Google Web Font -->
	<link href="/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href='//fonts.googleapis.com/css?family=Lato:100,300,400,700,900,100italic,300italic,400italic,700italic,900italic' rel='stylesheet' type='text/css'>

	<!-- Add custom CSS here -->
	<link href="/styles/landing-page.css" rel="stylesheet">
	
	<script>
	var access_token = '{{access_token}}';
	
	$(function() {
		$('#add_card').submit(function(e) {
			e.preventDefault();
			
			if(!validate()) return;
			
			$('#add_card').hide();
			
			var card_number = $('#card_number').val().replace(/\s+/g,'');
			var expiration = $('#card_exp').val().replace(/\s+/g,'').split('/');
			
			if(expiration[1].length == 2) expiration[1] = '20' + expiration[1];
			
			$.post('/api/link', {

				card: card_number,
				access_token: access_token,
				exp_month: expiration[0],
				exp_year: expiration[1]
			
			}, function(response) {
			
				if(response.error) {
					$('#add_card').show();
					alert('Error: ' + response.error);
				} else if(response.success) {
					window.location.reload();
				}
			
			}, 'JSON');
		});
		
		$('.card_delete').click(function() {
			if(confirm('Are you sure you want to delete this card?')) {
				var hash = $(this).parents('.card').attr('hash');
				
				$.post('/api/link', {
					
					access_token: access_token,
					hash: hash
				
				}, function(response) {
				
					if(response.error) {
						alert('Error: ' + response.error);
					} else if(response.success) {
						window.location.reload();
					}
				
				}, 'JSON');
			}
		});
		
		$('#card_number').formatCardNumber();
		$('#card_exp').formatCardExpiry();
		
		var validate = function() {
			var valid = true;
			
			var card_number = $('#card_number').val();
			var expiration = $('#card_exp').val().replace(/\s+/g,'').split('/');
			
			if(!$.validateCardNumber(card_number)) {
				valid = false;
				$('#card_number').parents('.form-group').addClass('has-error');
			} else {
				$('#card_number').parents('.form-group').removeClass('has-error');
			}
			
			if(expiration.length != 2 || (!$.validateCardExpiry(expiration[0], expiration[1]) && !$.validateCardExpiry(expiration[0], '20'+expiration[1]))) {
				valid = false;
				$('#card_exp').parents('.form-group').addClass('has-error');
			} else {
				$('#card_exp').parents('.form-group').removeClass('has-error');
			}
			
			return valid;
		}
		
		$('#card_number').keyup(validate);
		$('#card_exp').keyup(validate);
		
		$('#card_number').blur(validate);
		$('#card_exp').blur(validate);
		
		$('#card_number').focus(validate);
		$('#card_exp').focus(validate);
	});
	</script>
</head>

<body>

	<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<a class="navbar-brand" href="/">Cardwolla</a>
			</div>
		</div>
	</nav>
	
	<div class="card-content">
		{{#if cards}}
			<h1>Your Linked Cards</h1>
			{{#each cards}}
				<div class="card {{this.type}}" hash="{{@key}}">
					<div class="card_bg"></div>
					<div class="card_number">**** **** **** ****</div>
					<div class="card_exp_text">Exp.</div>
					<div class="card_expiration">{{this.exp_month}}/{{this.exp_year}}</div>
					<div class="card_type">{{this.type}}</div>
					<div class="card_linked">Card linked {{this.time_linked}}</div>
					<div class="card_delete">X</div>
				</div>
			{{/each}}
		
			<h1>Link Another Card</h1>
		{{else}}
			<h1>You Haven't Linked any Cards</h1>
			<p>Link your first card.</p><br />
		{{/if}}
		
			<form class="form-inline" role="form" id="add_card" autocomplete="on" pattern="\d*">
				<div class="form-group">
					<label class="inline-lbl control-label" for="card_number">Card Number</label>
					<input type="text" class="form-control input-lg" id="card_number" placeholder="1111 2222 3333 4444" />
				</div>
				<div class="form-group">
					<label class="inline-lbl control-label" for="exp">Expiration</label>
					<input type="text" class="form-control input-lg" id="card_exp" placeholder="12/2020" />
				</div>
				<br /><br />
				<button type="submit" class="btn btn-primary btn-lg">Add Card</button>
			</form>
	</div>

	<footer>
		<div class="container">
			<div class="row">
				<div class="col-lg-12">
					<p class="copyright text-muted small">Copyright &copy; Cardwolla 2014. All Rights Reserved</p>
				</div>
			</div>
		</div>
	</footer>
	
	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	
	  ga('create', 'UA-48092075-1', 'cardwolla.com');
	  ga('send', 'pageview');
	
	</script>
</body>

</html>
